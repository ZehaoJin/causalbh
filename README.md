# Causalbh

### [Paper: A data-driven discovery of the causal connection between galaxy and black hole evolution](https://ui.adsabs.harvard.edu/)
### [1. Installation](#1-installation-1)
### [2. Causal discovery with BGe exact posterior calculation](#2-causal-discovery-with-bge-exact-posterior-calculation-1)
### [3. Extensions: PC, FCI and DAG-GFN](#3-extensions-pc-fci-and-dag-gfn-1)
### [4. Data: Black hole mass - galaxy property catalog](#4-data-black-hole-mass---galaxy-property-catalog-1)
### [5. Reproduce paper plots](#5-reproduce-paper-plots-1)
### [6. Cite this work](#6-cite-this-work-1)

## 1. Installation
### 1.1. clone this repository to your machine

    git clone git@github.com:ZehaoJin/causalbh.git
    
or

    git clone https://github.com/ZehaoJin/causalbh.git

### 1.2. Install dependencies
- We highly recommand install dependencies in a virtual python environment via conda:
        
      conda create --name causalbh
      conda activate causalbh

- Install the GPU version of [jax](https://jax.readthedocs.io/en/latest/installation.html)
- To visualize causal graphs, perform analysis around causal graphs, install [networkx](https://networkx.org/), [pygraphviz](https://pygraphviz.github.io/), and [causallearn](https://causal-learn.readthedocs.io/en/latest/)
- some basic dependencies such as numpy, scipy, pandas, matplotlib, seaborn, tqdm


## 2. Causal discovery with BGe exact posterior calculation
exact posterior is not recommanded for number of nodes $n>7$, see [3. Extensions: PC, FCI and DAG-GFN](#3-extensions-pc-fci-and-dag-gfn) for cases $n>7$.
### 2.1. Generate all possible DAGs for n nodes
- Run [generate_all_dags.py](generate_all_dags.py). Specify the output location and number of nodes $n$ in the script.
- Or, use this multiprocessing version [generate_all_dags_mp.py](generate_all_dags_mp.py). It is also recommanded to verify the generated DAGs are valid using [Verify DAGs.ipynb](Verify DAGs.ipynb) if generated by the multiprocessing version

### 2.2 Compute BGe exact posteriors, edge/path marginals
Follow [marginals.ipynb](marginals.ipynb) to calculate exact posteriors, and plot edge/path marginals


## 3. Extensions: PC, FCI and DAG-GFN
### 3.1. Constriant-Based methods such as PC and FCI
We recommand using the [causallearn](https://causal-learn.readthedocs.io/en/latest/) implementation of PC and FCI alogrithm. Code example can be found [here](https://causal-learn.readthedocs.io/en/latest/search_methods_index/Constraint-based%20causal%20discovery%20methods/PC.html)

### 3.2 DAG-GFlowNet
When the exact posterior approach is computationally infeasible (usually $n>7$), DAG-GFN can be used to approximate the exact posteriors. See [DAG-GFN](https://github.com/tristandeleu/jax-dag-gflownet) for the implementation of DAG-GFN

## 4. Data: Black hole mass - galaxy property catalog
- A master catalog that covers 145 SMBHs and more than 100 galaxy properties can be found in [SMBH_Data_03_15_24v2.csv](SMBH_Data_03_15_24v2.csv)
- Sub-catalogs used in this work is sliced from the master catalog. These catalog can be found in this [folder](R_e_data). The main result of the paper comes from [causal_BH_ell.csv](R_e_data/causal_BH_ell.csv),[causal_BH_len.csv](R_e_data/causal_BH_len.csv), and [R_e_data/causal_BH_spr.csv](causal_BH_spr.csv).

## 5. Reproduce paper plots
[marginals_base+distance.ipynb](marginals_base+distance.ipynb): main result, and distance as a possible confounder/
[marginals_SAM.ipynb](marginals_SAM.ipynb): Semi-analytical models
[marginals_stds.ipynb](marginals_stds.ipynb): random sampling from observation errors
[marginals_LOO.ipynb](marginals_LOO.ipynb): Leave-One-Out cross validation
[read_exact_posterior.ipynb](read_exact_posterior.ipynb): Plot causal graphs
[paper_plots_0305.ipynb](paper_plots_0305.ipynb): Plots related to DAG-GFN

## 6. Cite this work
If you use this repository or would like to refer the paper, please use the following BibTeX entry:
    @article{
    }

